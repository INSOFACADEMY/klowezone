// Prisma schema for KloweZone Admin Panel
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ========================================
// AUTH & RBAC SYSTEM
// ========================================

model User {
  id              String   @id @default(cuid())
  email           String   @unique
  password        String
  firstName       String
  lastName        String
  telefono        String?
  avatar          String?
  isActive        Boolean  @default(true)
  isVerified      Boolean  @default(false)
  roleId          String
  metaCampaignId  String?  // ID de campaña de Meta que atrajo a este cliente
  lastLogin       DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  role              Role              @relation(fields: [roleId], references: [id])
  organizationMemberships OrganizationMember[]
  auditLogs         AuditLog[]
  errorLogs         ErrorLog[]
  incidentsAssigned Incident[] @relation("incidentAssignee")
  incidentsReported Incident[] @relation("incidentReporter")
  feedbackCreated   Feedback[] @relation("feedbackUser")
  feedbackAssigned  Feedback[] @relation("feedbackAssignee")
  metricDashboards  MetricDashboard[]
  incidentComments  IncidentComment[]
  feedbackComments  FeedbackComment[]
  blogPosts         BlogPost[]
  automationWorkflows AutomationWorkflow[]
  pages             Page[]
  testimonials      Testimonial[]
  mediaFiles        MediaFile[]
  metricEvents      MetricEvent[]
  projectsAsClient   Project[] @relation("projectClient")
  projectsAsOwner    Project[] @relation("projectOwner")
  uploadedDocuments  ProjectDocument[]
  createdExpenses    ProjectExpense[] @relation("expenseCreator")
  approvedExpenses   ProjectExpense[] @relation("expenseApprover")
  teamMemberships    ProjectTeamMember[] @relation("teamMember")
  teamAssignments    ProjectTeamMember[] @relation("teamAssigner")

  @@map("users")
}

// ========================================
// MULTI-TENANT ORGANIZATIONS
// ========================================

model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  logo        String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  members     OrganizationMember[]
  systemConfigs SystemConfig[]
  emailProviders EmailProvider[]
  aiProviders AIProvider[]
  storageProviders StorageProvider[]
  auditLogs AuditLog[]
  metricEvents MetricEvent[]
  metricDashboards MetricDashboard[]
  automationWorkflows AutomationWorkflow[]
  automationActions AutomationAction[]
  automationRuns AutomationRun[]
  jobQueues JobQueue[]
  projects Project[]
  projectDocuments ProjectDocument[]
  projectActivities ProjectActivity[]
  projectExpenses ProjectExpense[]
  projectTeamMembers ProjectTeamMember[]

  @@map("organizations")
}

model OrganizationMember {
  id             String   @id @default(cuid())
  organizationId String
  userId         String
  role           OrgRole  @default(MEMBER)
  joinedAt       DateTime @default(now())

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId]) // Un usuario solo puede estar una vez por organización
  @@map("organization_members")
}

enum OrgRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isSystem    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users       User[]
  permissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String   @id @default(cuid())
  name        String   @unique
  resource    String   // e.g., "users", "posts", "settings"
  action      String   // e.g., "create", "read", "update", "delete"
  description String?
  createdAt   DateTime @default(now())

  // Relations
  roles       RolePermission[]

  @@map("permissions")
}

model RolePermission {
  id           String @id @default(cuid())
  roleId       String
  permissionId String

  // Relations
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

// ========================================
// SYSTEM CONFIGURATION
// ========================================

model SystemConfig {
  id             String   @id @default(cuid())
  key            String
  value          String   // Encrypted JSON
  category       String   // "email", "ai", "storage", "system"
  isSecret       Boolean  @default(false)
  organizationId String?  // Multi-tenant support
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([key, organizationId]) // Key unique per organization
  @@map("system_config")
}

model EmailProvider {
  id             String   @id @default(cuid())
  name           String
  provider       String   // "smtp", "sendgrid", "resend"
  config         String   // Encrypted JSON with credentials
  isActive       Boolean  @default(false)
  isDefault      Boolean  @default(false)
  organizationId String?  // Multi-tenant support
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([name, organizationId]) // Name unique per organization
  @@map("email_providers")
}

model AIProvider {
  id             String   @id @default(cuid())
  name           String
  provider       String   // "openai", "anthropic", "google"
  model          String   // "gpt-4", "claude-3", etc.
  config         String   // Encrypted JSON with API keys
  isActive       Boolean  @default(false)
  isDefault      Boolean  @default(false)
  rateLimit      Int      @default(100) // requests per minute
  monthlyLimit   Int      @default(10000)
  organizationId String?  // Multi-tenant support
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([name, organizationId]) // Name unique per organization
  @@map("ai_providers")
}

model StorageProvider {
  id             String   @id @default(cuid())
  name           String
  provider       String   // "s3", "r2", "local"
  config         String   // Encrypted JSON with credentials
  bucket         String
  region         String?
  isActive       Boolean  @default(false)
  isDefault      Boolean  @default(false)
  organizationId String?  // Multi-tenant support
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([name, organizationId]) // Name unique per organization
  @@map("storage_providers")
}

// ========================================
// CMS SYSTEM
// ========================================

model BlogPost {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  content     String   // Markdown content
  excerpt     String?
  coverImage  String?
  status      PostStatus @default(DRAFT)
  seoTitle    String?
  seoDescription String?
  tags        String[]  // Array of tags
  authorId    String
  publishedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  author      User     @relation(fields: [authorId], references: [id])

  @@map("blog_posts")
}

model Page {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  content     String   // HTML/Markdown content
  status      PostStatus @default(DRAFT)
  seoTitle    String?
  seoDescription String?
  authorId    String
  publishedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  author      User     @relation(fields: [authorId], references: [id])

  @@map("pages")
}

model Testimonial {
  id          String   @id @default(cuid())
  name        String
  position    String?
  company     String?
  content     String
  avatar      String?
  rating      Int      @default(5) // 1-5 stars
  isActive    Boolean  @default(true)
  authorId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  author      User     @relation(fields: [authorId], references: [id])

  @@map("testimonials")
}

model MediaFile {
  id          String   @id @default(cuid())
  filename    String
  originalName String
  mimeType    String
  size        Int
  url         String
  thumbnail   String?
  alt         String?
  tags        String[]  // Array of tags
  folder      String    @default("general")
  uploadedBy  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  uploader    User     @relation(fields: [uploadedBy], references: [id])

  @@map("media_files")
}

// ========================================
// METRICS & ANALYTICS
// ========================================

model MetricEvent {
  id             String   @id @default(cuid())
  eventName      String
  eventData      Json     // Flexible JSON data
  userId         String?
  organizationId String?  // Multi-tenant support
  sessionId      String?
  userAgent      String?
  ipAddress      String?
  referrer       String?
  timestamp      DateTime @default(now())

  // Relations
  user        User?         @relation(fields: [userId], references: [id])
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("metric_events")
}

model MetricDashboard {
  id             String   @id @default(cuid())
  name           String
  description    String?
  config         Json     // Dashboard configuration
  isPublic       Boolean  @default(false)
  createdBy      String
  organizationId String?  // Multi-tenant support
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  creator     User         @relation(fields: [createdBy], references: [id])
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("metric_dashboards")
}

// ========================================
// LOGGING SYSTEM
// ========================================

model ErrorLog {
  id          String   @id @default(cuid())
  level       LogLevel
  message     String
  stack       String?
  url         String?
  method      String?
  statusCode  Int?
  userId      String?
  requestId   String   @unique
  userAgent   String?
  ipAddress   String?
  timestamp   DateTime @default(now())

  // Relations
  user        User?    @relation(fields: [userId], references: [id])

  @@map("error_logs")
}

model AuditLog {
  id             String   @id @default(cuid())
  action         String   // "create", "update", "delete"
  resource       String   // "user", "post", "setting"
  resourceId     String?
  oldValues      Json?
  newValues      Json?
  userId         String
  organizationId String?  // Multi-tenant support
  ipAddress      String?
  userAgent      String?
  timestamp      DateTime @default(now())

  // Relations
  user        User         @relation(fields: [userId], references: [id])
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("audit_logs")
}

model Incident {
  id          String     @id @default(cuid())
  title       String
  description String
  severity    IncidentSeverity
  status      IncidentStatus @default(OPEN)
  assignedTo  String?
  reportedBy  String
  resolvedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  assignee    User?     @relation("incidentAssignee", fields: [assignedTo], references: [id])
  reporter    User      @relation("incidentReporter", fields: [reportedBy], references: [id])
  comments    IncidentComment[]

  @@map("incidents")
}

model IncidentComment {
  id          String   @id @default(cuid())
  content     String
  incidentId  String
  authorId    String
  createdAt   DateTime @default(now())

  // Relations
  incident    Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  author      User     @relation(fields: [authorId], references: [id])

  @@map("incident_comments")
}

// ========================================
// FEEDBACK SYSTEM
// ========================================

model Feedback {
  id          String   @id @default(cuid())
  type        FeedbackType
  priority    FeedbackPriority @default(MEDIUM)
  title       String
  description String
  screenshot  String?
  url         String?
  userAgent   String?
  userId      String?
  status      FeedbackStatus @default(PENDING)
  assignedTo  String?
  resolvedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User?    @relation("feedbackUser", fields: [userId], references: [id])
  assignee    User?    @relation("feedbackAssignee", fields: [assignedTo], references: [id])
  comments    FeedbackComment[]

  @@map("feedback")
}

model FeedbackComment {
  id          String   @id @default(cuid())
  content     String
  feedbackId  String
  authorId    String
  isInternal  Boolean  @default(false) // Only visible to admins
  createdAt   DateTime @default(now())

  // Relations
  feedback    Feedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
  author      User     @relation(fields: [authorId], references: [id])

  @@map("feedback_comments")
}

// ========================================
// ENUMS
// ========================================

enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum LogLevel {
  DEBUG
  INFO
  WARN
  ERROR
  FATAL
}

enum IncidentSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum IncidentStatus {
  OPEN
  INVESTIGATING
  RESOLVED
  CLOSED
}

enum FeedbackType {
  BUG
  FEATURE_REQUEST
  IMPROVEMENT
  GENERAL
}

enum FeedbackPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum FeedbackStatus {
  PENDING
  REVIEWED
  IN_PROGRESS
  RESOLVED
  CLOSED
}

// ========================================
// AUTOMATION SYSTEM
// ========================================

enum TriggerType {
  NEW_LEAD
  PROJECT_STATUS_CHANGE
  FEEDBACK_RECEIVED
  CRITICAL_ERROR
  USER_REGISTERED
  PAYMENT_RECEIVED
  DEADLINE_APPROACHING
}

enum ActionType {
  SEND_EMAIL
  CREATE_NOTIFICATION
  LOG_TO_SLACK
  UPDATE_RECORD
  CREATE_TASK
  RUN_AI_ANALYSIS
  SEND_WEBHOOK
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  RETRYING
}

model AutomationWorkflow {
  id             String   @id @default(cuid())
  name           String
  description    String?
  isActive       Boolean  @default(false)
  trigger        TriggerType
  triggerConfig  Json     // Configuration for the trigger (filters, conditions)
  organizationId String?  // Multi-tenant support
  actions        AutomationAction[]
  createdBy      String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  creator      User               @relation(fields: [createdBy], references: [id])
  organization Organization?      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  runs         AutomationRun[]

  @@unique([name, organizationId]) // Name unique per organization
  @@map("automation_workflows")
}

model AutomationAction {
  id             String   @id @default(cuid())
  workflowId     String
  order          Int      // Execution order
  type           ActionType
  config         Json     // Action-specific configuration
  delay          Int      @default(0) // Delay in seconds before execution
  organizationId String?  // Multi-tenant support
  createdAt      DateTime @default(now())

  // Relations
  workflow     AutomationWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  organization Organization?       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  jobs         JobQueue[]          // Reverse relation to JobQueue

  @@map("automation_actions")
}

model AutomationRun {
  id             String   @id @default(cuid())
  workflowId     String
  triggerData    Json     // Data that triggered the automation
  status         JobStatus @default(PENDING)
  startedAt      DateTime?
  completedAt    DateTime?
  error          String?
  retryCount     Int      @default(0)
  maxRetries     Int      @default(3)
  organizationId String?  // Multi-tenant support
  createdAt      DateTime @default(now())

  // Relations
  workflow     AutomationWorkflow @relation(fields: [workflowId], references: [id])
  organization Organization?       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  jobs         JobQueue[]

  @@map("automation_runs")
}

model JobQueue {
  id             String   @id @default(cuid())
  runId          String
  actionId       String
  status         JobStatus @default(PENDING)
  payload        Json     // Job execution data
  priority       Int      @default(1) // 1=low, 5=high
  scheduledFor   DateTime @default(now())
  startedAt      DateTime?
  completedAt    DateTime?
  error          String?
  retryCount     Int      @default(0)
  maxRetries     Int      @default(3)
  organizationId String?  // Multi-tenant support
  createdAt      DateTime @default(now())

  // Relations
  run          AutomationRun     @relation(fields: [runId], references: [id])
  action       AutomationAction  @relation(fields: [actionId], references: [id])
  organization Organization?      @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("job_queue")
}

// ========================================
// PROJECT MANAGEMENT SYSTEM
// ========================================

model Project {
  id                   String   @id @default(cuid())
  cliente_id           String
  user_id              String
  nombre_proyecto      String
  descripcion          String?
  estado               ProjectStatus @default(PLANIFICACION)
  prioridad            Priority @default(MEDIA)
  fecha_entrega        DateTime?
  presupuesto_estimado Float?
  precio_venta         Float?
  organizationId       String?  // Multi-tenant support
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  // Relations
  cliente           User               @relation("projectClient", fields: [cliente_id], references: [id])
  owner             User               @relation("projectOwner", fields: [user_id], references: [id])
  organization      Organization?      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  documents         ProjectDocument[]
  activities        ProjectActivity[]
  expenses          ProjectExpense[]
  teamMembers       ProjectTeamMember[]

  @@map("proyectos")
}

model ProjectDocument {
  id             String   @id @default(cuid())
  project_id     String
  nombre         String
  tipo           DocumentType
  url            String
  size           Int?
  uploaded_by    String
  organizationId String?  // Multi-tenant support
  created_at     DateTime @default(now())

  // Relations
  project       Project     @relation(fields: [project_id], references: [id], onDelete: Cascade)
  uploader      User        @relation(fields: [uploaded_by], references: [id])
  organization  Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("project_documents")
}

model ProjectActivity {
  id             String   @id @default(cuid())
  project_id     String
  tipo           ActivityType
  titulo         String
  descripcion    String
  organizationId String?  // Multi-tenant support
  created_at     DateTime @default(now())

  // Relations
  project       Project     @relation(fields: [project_id], references: [id], onDelete: Cascade)
  organization  Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("project_activities")
}

model ProjectExpense {
  id             String   @id @default(cuid())
  project_id     String
  descripcion    String
  monto          Float
  tipo           ExpenseType
  fecha_gasto    DateTime
  comprobante    String?  // URL del comprobante/receipt
  aprobado_por   String?  // User ID who approved
  created_by     String   // User ID who created
  organizationId String?  // Multi-tenant support
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  // Relations
  project       Project     @relation(fields: [project_id], references: [id], onDelete: Cascade)
  creador       User        @relation("expenseCreator", fields: [created_by], references: [id])
  aprobador     User?       @relation("expenseApprover", fields: [aprobado_por], references: [id])
  organization  Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("project_expenses")
}

model ProjectTeamMember {
  id             String   @id @default(cuid())
  project_id     String
  user_id        String
  rol            TeamRole
  asignado_en    DateTime @default(now())
  asignado_por   String   // User ID who assigned
  horas_estimadas Int?    // Estimated hours for this project
  tarifa_hora    Float?   // Hourly rate for this member
  activo         Boolean  @default(true)
  organizationId String?  // Multi-tenant support

  // Relations
  project       Project     @relation(fields: [project_id], references: [id], onDelete: Cascade)
  miembro       User        @relation("teamMember", fields: [user_id], references: [id])
  asignador     User        @relation("teamAssigner", fields: [asignado_por], references: [id])
  organization  Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([project_id, user_id]) // Un usuario solo puede estar una vez por proyecto
  @@map("project_team_members")
}

// Enums
enum ProjectStatus {
  PLANIFICACION
  EN_PROGRESO
  COMPLETADO
  PAUSADO
  CANCELADO
}

enum Priority {
  BAJA
  MEDIA
  ALTA
  URGENTE
}

enum DocumentType {
  CONTRATO
  PROPUESTA
  FACTURA
  OTRO
}

enum ActivityType {
  EMAIL
  TASK_UPDATE
  PAYMENT
  MEETING
  DOCUMENT
}

enum ExpenseType {
  MATERIALES
  PERSONAL
  TRANSPORTE
  HERRAMIENTAS
  MARKETING
  LEGAL
  OTROS
}

// ========================================
// AI CAMPAIGN LOGGING SYSTEM
// ========================================

model AiCampaignLog {
  id               String   @id @default(cuid())
  campaignId       String   @unique // ID de la campaña en Meta
  name             String   // Nombre de la campaña
  spend            Float    @default(0) // Presupuesto gastado en la campaña
  leadsCount       Int      @default(0) // Número de leads generados
  revenueGenerated Float    @default(0) // Ingresos generados por la campaña
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("ai_campaign_logs")
}

enum TeamRole {
  PROJECT_MANAGER
  DEVELOPER
  DESIGNER
  QA_TESTER
  BUSINESS_ANALYST
  DEVOPS
  CONSULTANT
}
